{"version":3,"file":"index-Bg3llgLx.js","sources":["../../../app/administration/src/module/sw-in-app-purchases/component/sw-in-app-purchase-checkout/sw-in-app-purchase-checkout.html.twig","../../../app/administration/src/module/sw-in-app-purchases/component/sw-in-app-purchase-checkout/index.ts"],"sourcesContent":["{% block sw_in_app_purchase_checkout_modal %}\n<sw-modal\n    v-if=\"store.entry\"\n    class=\"sw-in-app-purchase-checkout\"\n    :title=\"$t('sw-in-app-purchase-checkout.modalTitle')\"\n    @modal-close=\"handleStateActions(false)\"\n>\n    <template v-if=\"state === 'purchase'\" #modal-title>\n        <sw-extension-icon\n            class=\"sw-in-app-purchase-checkout__icon\"\n            :src=\"extensionIcon\"\n        />\n\n        <div class=\"sw-in-app-purchase-checkout__titles\">\n            <h4 id=\"modalTitleEl\" class=\"sw-modal__title\">\n                {{ $t('sw-in-app-purchase-checkout.modalTitle') }}\n            </h4>\n\n            <h5 class=\"sw-modal__subtitle\">\n                {{ extension.label }}\n            </h5>\n        </div>\n    </template>\n\n    <sw-in-app-purchase-checkout-overview\n        v-if=\"state === 'purchase'\"\n        v-model:tos-accepted=\"tosAccepted\"\n        v-model:gtc-accepted=\"gtcAccepted\"\n        v-model:variant=\"variant\"\n        :purchase=\"purchase\"\n        :producer=\"extension.producerName\"\n    />\n\n    <sw-in-app-purchase-checkout-state\n        v-if=\"['loading', 'success', 'error'].includes(state)\"\n        :state=\"state\"\n        :error-snippet=\"errorMessage\"\n    />\n\n    <template #modal-footer>\n        <sw-in-app-purchase-checkout-button\n            :state=\"state\"\n            :tos-accepted=\"tosAccepted\"\n            :gtc-accepted=\"gtcAccepted\"\n            :variant=\"variant\"\n            @click=\"handleStateActions(true)\"\n        />\n    </template>\n</sw-modal>\n{% endblock %}\n","import type * as IAP from 'SwagExtensionStore/module/sw-in-app-purchases/types';\nimport template from './sw-in-app-purchase-checkout.html.twig';\nimport './sw-in-app-purchase-checkout.scss';\n\n/**\n * @private\n */\nexport default Shopware.Component.wrapComponentConfig({\n    template,\n\n    inject: [\n        'inAppPurchasesService',\n    ],\n\n    mixins: [\n        Shopware.Mixin.getByName('notification'),\n    ],\n\n    data() {\n        return {\n            state: 'loading' as 'loading' | 'purchase' | 'error' | 'success',\n            store: Shopware.Store.get('inAppPurchaseCheckout'),\n            inAppPurchaseCart: null as IAP.InAppPurchaseCart | null,\n            extension: null as IAP.Extension | null,\n            purchase: null as IAP.InAppPurchase | null,\n            tosAccepted: false,\n            gtcAccepted: false,\n            variant: null as string | null,\n            errorMessage: null as string | null,\n        };\n    },\n\n    created() {\n        this.createdComponent();\n    },\n\n    computed: {\n        assetFilter() {\n            return Shopware.Filter.getByName('asset');\n        },\n        extensionIcon() {\n            if (this.extension?.icon) {\n                return this.extension.icon;\n            }\n\n            if (this.extension?.iconRaw) {\n                return `data:image/png;base64, ${this.extension.iconRaw}`;\n            }\n\n            return this.assetFilter('/swagextensionstore/administration/static/img/theme/default_theme_preview.jpg');\n        },\n    },\n\n    methods: {\n        createdComponent() {\n            this.store.$subscribe(() => {\n                this.requestFeature();\n            });\n        },\n\n        async requestFeature() {\n            if (!this.store.extension || !this.store.entry) {\n                this.reset();\n\n                return;\n            }\n\n            this.state = 'loading';\n\n            await Promise.all([\n                this.inAppPurchasesService.getExtension(this.store.extension),\n                this.inAppPurchasesService.getPriceModels(this.store.extension, this.store.entry.identifier),\n            ]).then(([extension, purchase]) => {\n                this.purchase = purchase;\n                this.extension = extension;\n                this.state = 'purchase';\n            }).catch((errorResponse: ErrorResponse) => {\n                Shopware.Utils.debug.error(errorResponse);\n                this.errorMessage = this.getError(errorResponse);\n                this.state = 'error';\n            });\n        },\n\n        onPurchaseFeature() {\n            if (!this.store.extension || !this.store.entry || !this.variant) {\n                this.reset();\n\n                return;\n            }\n\n            this.inAppPurchasesService.createCart(\n                this.store.extension,\n                this.store.entry.identifier,\n                this.variant,\n            ).then((inAppPurchaseCart) => {\n                return this.inAppPurchasesService.orderCart(\n                    inAppPurchaseCart?.taxRate,\n                    inAppPurchaseCart?.positions,\n                    this.extension?.name,\n                );\n            }).then(() => {\n                this.state = 'success';\n            }).catch((errorResponse: ErrorResponse) => {\n                Shopware.Utils.debug.error(errorResponse);\n                this.errorMessage = this.getError(errorResponse);\n                this.state = 'error';\n            });\n        },\n\n        handleStateActions(isButton: boolean) {\n            switch (this.state) {\n                case 'purchase':\n                    if (isButton) {\n                        this.onPurchaseFeature();\n                    } else {\n                        this.reset();\n                    }\n                    break;\n                case 'error':\n                    if (isButton) {\n                        this.requestFeature();\n                    } else {\n                        this.reset();\n                    }\n                    break;\n                case 'success':\n                    this.reset();\n                    this.inAppPurchasesService.refreshInAppPurchases()\n                        .then(() => {\n                            window.location.reload();\n                        });\n                    break;\n                default:\n                    this.reset();\n                    break;\n            }\n        },\n\n        getError(errorResponse: ErrorResponse): string | null {\n            return errorResponse?.response?.data.errors[0]?.detail ?? null;\n        },\n\n        reset() {\n            this.store.dismiss();\n            this.inAppPurchaseCart = null;\n            this.extension = null;\n            this.errorMessage = null;\n            this.state = 'loading';\n            this.purchase = null;\n            this.variant = null;\n            this.tosAccepted = false;\n            this.gtcAccepted = false;\n        },\n    },\n});\n"],"names":["template","index","_a","_b","extension","purchase","errorResponse","inAppPurchaseCart","isButton"],"mappings":"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"}